<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.bc.pmpheep.back.authadmin.applydocaudit.dao.DeclareCountDao">
	<!--分页查询条件查询列表 -->
	<select id="findDeclareCount" resultType="java.util.Map"
		parameterType="java.util.Map">
		select
		t.textbook_name,
		sum(case dp.preset_position when '4' then 1 else
		0 end) as decid1,
		sum(case dp.preset_position when '2' then 1 else 0
		end) as decid2,
		sum(case dp.preset_position when '1' then 1 else 0 end)
		as decid3,
		sum(case dp.chosen_position when '4' then 1 else 0 end) as
		dp1,
		sum(case dp.chosen_position when '2' then 1 else 0 end) as dp2,
		sum(case dp.chosen_position when '1' then 1 else 0 end) as dp3
		from
		textbook t LEFT JOIN dec_position dp ON t.id=dp.textbook_id
		LEFT JOIN declaration as d on dp.declaration_id=d.id
		LEFT JOIN org as o on
		d.org_id=o.id
		INNER JOIN org_user as ou on d.org_id=ou.org_id and d.online_progress!=0
		<where>
			1=1
			<if test="material_id != null and material_id != '' ">
				and t.material_id = ${material_id}
			</if>
			<if test="userId != null and userId != '' ">
				and ou.id=${userId}
			</if>
		</where>
		GROUP BY t.id
		HAVING (decid1>=1 or decid2>=1 or decid3>=1)
	</select>


	<!-- 查看全部 我校申报情况统计 -->
	<select id="selectAll" resultType="java.util.Map" parameterType="java.util.Map">
		select
		t.textbook_name,
		sum(case dp.preset_position when '4' then 1 else
		0 end) as decid1,
		sum(case dp.preset_position when '2' then 1 else 0
		end) as decid2,
		sum(case dp.preset_position when '1' then 1 else 0 end)
		as decid3,
		sum(case dp.chosen_position when '4' then 1 else 0 end) as
		dp1,
		sum(case dp.chosen_position when '2' then 1 else 0 end) as dp2,
		sum(case dp.chosen_position when '1' then 1 else 0 end) as dp3
		from
		textbook t LEFT JOIN dec_position dp ON t.id=dp.textbook_id
		LEFT JOIN declaration as d on dp.declaration_id=d.id
		LEFT JOIN org as o on
		d.org_id=o.id
		INNER JOIN org_user as ou on d.org_id=ou.org_id and d.online_progress!=0
		<where>
			1=1
			<if test="material_id != null and material_id != '' ">
				and t.material_id = ${material_id}
			</if>
			<if test="userId != null and userId != '' ">
				and ou.id=${userId}
			</if>
		</where>
		GROUP BY t.id
	</select>

	<!--最终结果名单列表 加载更多 -->
	<select id="findNameList" resultType="java.util.Map"
		parameterType="java.util.Map">
			select t.*,COUNT(zb) as zbc,COUNT(fb) as fbc,COUNT(bw) as bwc from (	
		SELECT
		t.id,
		t.textbook_name,
		GROUP_CONCAT(
		(
		CASE dp.chosen_position
		WHEN '4' THEN
		d.realname
		END
		)
		) AS zb,
		GROUP_CONCAT(
		CASE dp.chosen_position
		WHEN '2' THEN
		d.realname
		END
		) AS fb,
		GROUP_CONCAT(
		CASE dp.chosen_position
		WHEN '1' THEN
		d.realname
		END
		) AS bw
		FROM
		textbook t LEFT JOIN dec_position dp ON t.id=dp.textbook_id
		LEFT JOIN declaration as d on dp.declaration_id=d.id
		LEFT JOIN org as o on
		d.org_id=o.id
		INNER JOIN org_user as ou on d.org_id=ou.org_id and d.online_progress!=0
		<where>
			1=1
			<if test="material_id != null and material_id != '' ">
				and t.material_id = ${material_id}
			</if>
			<if test="userId != null and userId != '' ">
				and ou.id=${userId}
			</if>
		</where>
		GROUP BY t.id
		
		) t  GROUP BY t.textbook_name HAVING zbc>=1 or fbc>=1 or bwc>=1
		
	</select>


	<!-- 查看全部 最终结果名单 导出excel -->
	<select id="selectResults" resultType="java.util.Map">
		SELECT
		t.id,
		t.textbook_name,
		GROUP_CONCAT(
		(
		CASE dp.chosen_position
		WHEN '4' THEN
		d.realname
		END
		)
		) AS zb,
		GROUP_CONCAT(
		CASE dp.chosen_position
		WHEN '2' THEN
		d.realname
		END
		) AS fb,
		GROUP_CONCAT(
		CASE dp.chosen_position
		WHEN '1' THEN
		d.realname
		END
		) AS bw
		FROM
		textbook t LEFT JOIN dec_position dp ON t.id=dp.textbook_id
		LEFT JOIN declaration as d on dp.declaration_id=d.id
		LEFT JOIN org as o on
		d.org_id=o.id
		INNER JOIN org_user as ou on d.org_id=ou.org_id and d.online_progress!=0
		<where>
			1=1
			<if test="material_id != null and material_id != '' ">
				and t.material_id = ${material_id}
			</if>
			<if test="userId != null and userId != '' ">
				and ou.id=${userId}
			</if>
		</where>
		GROUP BY t.id
	</select>

</mapper>
