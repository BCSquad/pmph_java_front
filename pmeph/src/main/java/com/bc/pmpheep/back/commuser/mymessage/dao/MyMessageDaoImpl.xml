<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.commuser.mymessage.dao.MyMessageDao">

	<select id="listMyMessage" resultType="MyMessageVO">
		select 
			if((sender_id = #{thisUserId}  and sender_type =2 ), <!--  ? --> 
				 b.receiver_id                                   <!--  如果消息是我发送的-->
				,    
				 b.sender_id                                     <!-- 如果消息是对方发送的-->
			) talkId ,
			if((sender_id = #{thisUserId}  and sender_type =2 ), <!--  ? --> 
				 if(receiver_type =1 ,pra.avatar,wra.avatar)     <!--  如果消息是我发送的-->
				,    
				 if(sender_type =1 ,psa.avatar,wsa.avatar)       <!-- 如果消息是对方发送的-->
			) avatar,
			if((sender_id = #{thisUserId}  and sender_type =2 ), <!--  ? --> 
				 if(receiver_type =1 ,pra.realname,wra.realname) <!-- 如果消息是我发送的-->
				,    
				 if(sender_type =1 ,psa.realname,wsa.realname)   <!-- 如果消息是对方发送的-->
			) name,
			if((sender_id = #{thisUserId}  and sender_type =2 ), <!--  ? --> 
				 b.receiver_type                                 <!-- 如果消息是我发送的-->
				,    
				 b.sender_type                                   <!-- 如果消息是对方发送的-->
			) type,
			b.msg_id,
			b.gmt_create  sendTime
		from (
			SELECT 
			MAX(id) id ,
			if(sum(if(is_read,1,0))>0,1,'') reade,                    
			if(sum(if(id>0,1,0)) > sum(if(is_read,1,0)) ,1,'') noread  from (
				select 
				id,
				is_read,
				IF((sender_id = #{thisUserId}  and sender_type =2 ),CONCAT(receiver_id,'_',receiver_type),CONCAT(sender_id,'_',sender_type)) object 
				from user_message 
				where  msg_type = 2 and is_deleted =0 and is_withdraw =0 and ((sender_id = #{thisUserId}  and sender_type =2 ) or (receiver_id = #{thisUserId}  and receiver_type =2) ) 
			) objecttable GROUP BY object 
		) a LEFT JOIN user_message b on a.id = b.id 
	    LEFT JOIN pmph_user psa on (sender_id = psa.id  and sender_type = 1)
	    LEFT JOIN writer_user wsa on (sender_id = wsa.id  and sender_type = 2)
	    LEFT JOIN pmph_user pra on (receiver_id = pra.id  and receiver_type = 1)
	    LEFT JOIN writer_user wra on (receiver_id = wra.id  and receiver_type = 2)
	    where 1 = 1
	    <if test="state != null ">
	    	<if test="state == 'reade' ">
	    		and reade  =1
	    	</if>
	    	<if test="state == 'noreade' ">
	    		and noread =1
	    	</if> 
	    </if>
	    order by b.gmt_create desc
	    limit #{start},#{pageSize}
	</select>
	
	<update id="updateMyTalk">
		update 
			user_message 
		set 
			is_read =true 
		where    receiver_id   = #{receiverId}  and receiver_type = #{receiverType} 
			  and sender_id    = #{senderId}    and sender_type   = #{senderType}
	</update>

	<select id="listMyMessageTotal" parameterType="PageParameter"
		resultType="Integer">
		SELECT count(*) FROM (SELECT
		*, MAX(m.gmt_create) sendTime
		FROM
		user_message m
		WHERE
		(m.receiver_id = #{parameter.userId} or m.sender_id =
		#{parameter.userId})
		AND (m.receiver_type =	#{parameter.userType}
		OR m.sender_type = #{parameter.userType}) 
		AND	m.is_deleted = FALSE
		AND	m.is_withdraw = FALSE
		AND m.msg_type = 2
		<if test="parameter.isRead != null">
			AND m.is_read = #{parameter.isRead}
		</if>
		GROUP BY m.sender_id
		ORDER BY sendTime DESC) t
	</select>
	
	<select id="listMyMessageDetail" resultType="MyMessageVO">
		SELECT
		*,m.gmt_create sendTime
		FROM
		user_message m
		WHERE
		(m.receiver_id =
		#{userId} OR m.sender_id = #{userId})
		AND
		(m.receiver_id = #{senderId}
		OR m.sender_id = #{senderType})
		AND
		(m.receiver_type = #{userType} OR
		m.sender_type = #{userType})
		AND
		(m.receiver_type = #{senderType} OR
		m.sender_type = #{senderType})
		ORDER BY sendTime DESC
	</select>

	<!-- 查询我与好友的对话记录 -->
	<select id="findMyDialogue" resultType="DialogueVO">
		select
			IF(a.sender_id = #{thisId} ,b.avatar  ,if(#{friendType} =2,b.avatar ,bb.avatar)) avatar, 
			IF(a.sender_id = #{thisId} ,b.realname,if(#{friendType} =2,b.realname,bb.realname)) senderName,
			a.msg_id,
			a.gmt_create
			sendTime,
			IF(a.sender_id = #{thisId} ,true,false) isMy
			from
			user_message a
				left join writer_user b on a.sender_id = b.id
	      		LEFT JOIN pmph_user   bb on a.sender_id = bb.id
			where
			a.msg_type = 2
			and
			a.is_withdraw = 0
			and a.is_deleted =0
			and ((a.sender_id = #{thisId}   and sender_type=2             and a.receiver_id = #{friendId} and receiver_type = #{friendType} )
				OR(a.sender_id = #{thisId}   AND sender_type=1             AND a.receiver_id =#{friendId} AND receiver_type = 2 )  
	          or (a.sender_id = #{friendId} and sender_type=#{friendType} and a.receiver_id = #{thisId}   and receiver_type =2 ))
		ORDER BY a.gmt_create asc
	</select>

	<sql id="key">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="msgId != null and msgId !=''">
				msg_id,
			</if>
			<if test="msgType != null">
				msg_type,
			</if>
			<if test="title != null and title !='' ">
				title,
			</if>
			<if test="senderId != null ">
				sender_id,
			</if>
			<if test="senderType != null ">
				sender_type,
			</if>
			<if test="receiverId != null ">
				receiver_id,
			</if>
			<if test="receiverType != null ">
				receiver_type,
			</if>
			<if test="isRead != null ">
				is_read,
			</if>
			<if test="isWithdraw != null ">
				is_withdraw,
			</if>
			<if test="isDeleted != null ">
				is_deleted,
			</if>
			<if test="gmtCreate != null ">
				gmt_create,
			</if>
			<if test="gmtUpdate != null ">
				gmt_update,
			</if>
		</trim>
	</sql>
	<!-- sql片段对应?,id属性值任意 -->
	<sql id="value">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="msgId != null and msgId !=''">
				#{msgId},
			</if>
			<if test="msgType != null">
				#{msgType},
			</if>
			<if test="title != null and title !='' ">
				#{title},
			</if>
			<if test="senderId != null ">
				#{senderId},
			</if>
			<if test="senderType != null ">
				#{senderType},
			</if>
			<if test="receiverId != null ">
				#{receiverId},
			</if>
			<if test="receiverType != null ">
				#{receiverType},
			</if>
			<if test="isRead != null ">
				#{isRead},
			</if>
			<if test="isWithdraw != null ">
				#{isWithdraw},
			</if>
			<if test="isDeleted != null ">
				#{isDeleted},
			</if>
			<if test="gmtCreate != null ">
				#{gmtCreate},
			</if>
			<if test="gmtUpdate != null ">
				#{gmtUpdate},
			</if>
		</trim>
	</sql>
	<!--单条插入 UserMessage -->
	<insert id="addUserMessage" parameterType="MyMessage">
		<selectKey resultType="java.lang.Long" order="AFTER"
			keyProperty="id"> <!-- order="AFTER"表示先执行插入语句，之后再执行查询语句 BEFORE 或 AFTER -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into
		user_message(
		<include refid="key" />
		)
		values (
		<include refid="value" />
		)
	</insert>

	<!-- 通过id 动态更新UserMessage -->
	<update id="updateUserMessage" parameterType="MyMessage">
		update user_message
		<set>
			<if test="msgId != null">
				msg_id = #{msgId},
			</if>
			<if test="msgType != null">
				msg_type = #{msgType},
			</if>
			<if test="title != null and title != '' ">
				title = #{title},
			</if>
			<if test="senderId != null">
				sender_id = #{senderId},
			</if>
			<if test="senderType != null">
				sender_type =#{senderType},
			</if>
			<if test="receiverId != null">
				receiver_id =#{receiverId},
			</if>
			<if test="receiverType != null">
				receiver_type = #{receiverType},
			</if>
			<if test="isRead != null">
				is_read =#{isRead},
			</if>
			<if test="isWithdraw != null">
				is_withdraw = #{isWithdraw},
			</if>
			<if test="isDeleted != null">
				is_deleted =#{isDeleted},
			</if>
			<if test="gmtCreate != null">
				gmt_create = #{gmtCreate},
			</if>
			<if test="gmtUpdate != null">
				gmt_update =#{gmtUpdate},
			</if>
		</set>
		where id = #{id} ;
	</update>

</mapper>