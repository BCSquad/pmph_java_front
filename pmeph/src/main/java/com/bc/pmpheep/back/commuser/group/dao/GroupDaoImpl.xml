<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.commuser.group.dao.GroupDao">

	<!-- 查当前用户的小组列表 -->
	<select id="list" resultType="GroupList">
		select
		g.*,
		t.textbook_name bookName
		from
		pmph_group g
		LEFT
		JOIN textbook t
		ON g.book_id = t.id
		where
		g.id
		in (
		select DISTINCT
		group_id from
		pmph_group_member where user_id = #{id}
		and
		is_writer =
		true AND
		is_deleted = FALSE
		)
		order by group_name
		limit
		#{start},#{pageSize}
	</select>

	<!-- 查当前用户的小组列表总数 -->
	<select id="getTotal" resultType="Long">
		SELECT
		COUNT(*)
		FROM
		pmph_group g
		LEFT JOIN textbook t ON g.book_id = t.id
		WHERE
		g.id IN (
		SELECT DISTINCT
		group_id
		FROM
		pmph_group_member
		WHERE
		user_id = #{id}
		AND
		is_writer = TRUE
		AND is_deleted = FALSE
		)
		ORDER BY
		group_name
	</select>
    <!-- 统计小组成员数 -->
    <select id="getMemberTotal" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        SELECT COUNT(user_id) FROM pmph_group_member WHERE group_id = #{groupId};
    </select>
    <!-- 统计小组文件数 -->
    <select id="getFileTotal" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        SELECT COUNT(file_id) FROM pmph_group_file WHERE group_id = #{groupId};
    </select>
    <!-- 获取小组所有成员的头像 -->
    <select id="getAvatars" parameterType="java.lang.Long" 
        resultType="String">
        SELECT IFNULL(b.avatar,c.avatar) 
		FROM pmph_group_member a 
		LEFT JOIN pmph_user b ON (a.user_id = b.id AND a.is_writer = 0) 
		LEFT JOIN writer_user c ON (a.user_id = c.id AND a.is_writer = 1) 
		WHERE a.group_id = #{groupId};
    </select>
    <!-- 获取小组动态 -->
    <select id="getMessages" parameterType="java.lang.Long" 
        resultType="GroupMessage">
        SELECT * FROM pmph_group_message 
        WHERE  group_id = #{groupId} ORDER BY gmt_create DESC
    </select>
    <!-- 获取小组文件列表 -->
    <select id="getFiles" parameterType="java.lang.Long" 
        resultType="GroupFile">
        SELECT * FROM pmph_group_file WHERE group_id=#{groupId} 
        <if test="fileName !=null and fileName !=''">
        AND file_name = #{fileName}
        </if>
        ORDER BY gmt_create DESC 
        limit
		#{start},#{pageSize}
        ;
    </select>
    <delete id="deleteFile" parameterType="java.lang.Long">
        DELETE FROM pmph_group_file WHERE id = #{id};
    </delete>
    
    <!-- 根据组员id查询PmphGroupMember -->
	<select id="getPmphGroupMemberByMemberId" resultType="PmphGroupMemberVO">
		select *
		from pmph_group_member where
		group_id=#{groupId} and
		user_id= #{userId};
	</select>
	
	<!-- 根据小组id查询小组所有成员 -->
	<select id="listPmphGroupMember" parameterType="java.lang.Long"
		resultType="PmphGroupMemberVO">
		select * from pmph_group_member where
		group_id=#{groupId}
		and is_deleted = false
		order by is_founder DESC ,is_admin DESC;
	</select>
	
	<sql id="key">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="groupId != null and groupId !=''">
				group_id,
			</if>
			<if test="memberId != null and memberId !=''">
				member_id,
			</if>
			<if test="fileId != null and fileId !=''">
				file_id,
			</if>
			<if test="fileName != null and fileName !=''">
				file_name,
			</if>
			<if test="download != null and download !=''">
				download,
			</if>
		</trim>
	</sql>
	<!-- sql片段对应?,id属性值任意 -->
	<sql id="value">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="groupId !=null and groupId !=''">
				#{groupId},
			</if>
			<if test="memberId !=null and memberId !=''">
				#{memberId},
			</if>
			<if test="fileId !=null and fileId !=''">
				#{fileId},
			</if>
			<if test="fileName !=null and fileName !=''">
				#{fileName},
			</if>
			<if test="download !=null and download !=''">
				#{download},
			</if>
		</trim>
	</sql>

	<!-- 新增 GroupFile -->
	<insert id="addGroupFile" parameterType="GroupFile">
		<selectKey resultType="java.lang.Long" order="AFTER"
			keyProperty="id"> <!-- order="AFTER"表示先执行插入语句，之后再执行查询语句 BEFORE 或 AFTER -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into pmph_group_file (
		<include refid="key" />
		)
		values(
		<include refid="value" />
		) ;
	</insert>
	
	<!-- 根据组员id查询PmphGroupMember -->
	<select id="getGroupMember" resultType="GroupMember">
		select *
		from pmph_group_member where
		group_id=#{groupId} and
		user_id= #{userId}
		;
	</select>
	
	<!-- 更新 GroupFile -->
	<update id="updateGroupFile" parameterType="GroupFile">
		update
		pmph_group_file
		<set>
			<if test="groupId != null and groupId !=''">
				group_id = #{groupId},
			</if>
			<if test="memberId != null and memberId !='' ">
				member_id = #{memberId},
			</if>
			<if test=" fileId != null and fileId !=''">
				file_id= #{fileId},
			</if>
			<if test=" fileName != null and fileName !=''">
				file_name= #{fileName},
			</if>
			<if test=" download != null and download !=''">
				download = #{download},
			</if>
		</set>
		where id=#{id} ;
	</update>
	
	<sql id="key">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="groupId != null and groupId !=''">
				group_id,
			</if>
			<if test="memberId != null">
				member_id,
			</if>
			<if test="msgContent != null and msgContent !=''">
				msg_content,
			</if>
		</trim>
	</sql>
	<!-- sql片段对应?,id属性值任意 -->
	<sql id="value">
		<!-- 去掉最后一个, -->
		<trim suffixOverrides=",">
			<if test="groupId != null and groupId !=''">
				#{groupId},
			</if>
			<if test="memberId != null ">
				#{memberId},
			</if>
			<if test="msgContent != null and msgContent !=''">
				#{msgContent},
			</if>
		</trim>
	</sql>

	<!-- 新增 GroupMessage -->
	<insert id="addGroupMessage" parameterType="GroupMessage">
		<selectKey resultType="java.lang.Long" order="AFTER"
			keyProperty="id"> <!-- order="AFTER"表示先执行插入语句，之后再执行查询语句 BEFORE 或 AFTER -->
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into pmph_group_message (
		<include refid="key" />
		)
		values(
		<include refid="value" />
		) ;
	</insert>
	
	<!-- 根据id查询一个 GroupMessage -->
	<select id="getGroupMessageById" parameterType="java.lang.Long"
		resultType="GroupMessage">
		select * from pmph_group_message where
		id=#{id} ;
	</select>
	
	<!-- 更新 Group -->
	<update id="updateGroup" parameterType="Group">
		update
		pmph_group
		<set>
			<if test="groupName != null and groupName !=''">
				group_name = #{groupName},
			</if>
			<if test="groupImage != null and groupImage !='' ">
				group_image = #{groupImage},
			</if>
			<if test=" founderId != null and founderId !=''">
				founder_id= #{founderId},
			</if>
			<if test=" bookId != null and bookId !=''">
				book_id= #{bookId},
			</if>
			<if test=" note != null and note !=''">
				note = #{note},
			</if>
			<if test="gmtLastMessage !=null ">
				gmt_Last_Message = #{gmtLastMessage},
			</if>
		</set>
		where id=#{id} ;
	</update>
	
	<!-- 更新 下载次数 -->
	<update id="updateGroupFileOfDownload" >
		update
		pmph_group_file set download=download+1 WHERE group_id = #{groupId}
		AND
		file_id = #{fileId}
	</update>
</mapper>
