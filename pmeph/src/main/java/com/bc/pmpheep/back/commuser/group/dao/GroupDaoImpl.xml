<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bc.pmpheep.back.commuser.group.dao.GroupDao">

	<!-- 查当前用户的小组列表 -->
	<select id="list" resultType="GroupList">
		select
		g.*,
		t.textbook_name bookName
		from
		pmph_group g
		LEFT
		JOIN textbook t
		ON g.book_id = t.id
		where
		g.id
		in (
		select DISTINCT
		group_id from
		pmph_group_member where user_id = #{id}
		and
		is_writer =
		true AND
		is_deleted = FALSE
		)
		order by group_name
		limit
		#{start},#{pageSize}
	</select>

	<!-- 查当前用户的小组列表总数 -->
	<select id="getTotal" resultType="Long">
		SELECT
		COUNT(*)
		FROM
		pmph_group g
		LEFT JOIN textbook t ON g.book_id = t.id
		WHERE
		g.id IN (
		SELECT DISTINCT
		group_id
		FROM
		pmph_group_member
		WHERE
		user_id = #{id}
		AND
		is_writer = TRUE
		AND is_deleted = FALSE
		)
		ORDER BY
		group_name
	</select>
    <!-- 统计小组成员数 -->
    <select id="getMemberTotal" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        SELECT COUNT(user_id) FROM pmph_group_member WHERE group_id = #{groupId};
    </select>
    <!-- 统计小组文件数 -->
    <select id="getFileTotal" parameterType="java.lang.Long" 
        resultType="java.lang.Integer">
        SELECT COUNT(file_id) FROM pmph_group_file WHERE group_id = #{groupId};
    </select>
    <!-- 获取小组所有成员的头像 -->
    <select id="getAvatars" parameterType="java.lang.Long" 
        resultType="String">
        SELECT IFNULL(b.avatar,c.avatar) 
		FROM pmph_group_member a 
		LEFT JOIN pmph_user b ON (a.user_id = b.id AND a.is_writer = 0) 
		LEFT JOIN writer_user c ON (a.user_id = c.id AND a.is_writer = 1) 
		WHERE a.group_id = #{groupId};
    </select>
    <!-- 获取小组动态 -->
    <select id="getMessages" parameterType="java.lang.Long" 
        resultType="GroupMessage">
        SELECT * FROM pmph_group_message 
        WHERE member_id = 0 AND group_id = #{groupId} ORDER BY gmt_create DESC
    </select>
    <!-- 获取小组文件列表 -->
    <select id="getFiles" parameterType="java.lang.Long" 
        resultType="GroupFile">
        SELECT * FROM pmph_group_file WHERE group_id=#{groupId} 
        <if test="fileName !=null and fileName !=''">
        AND file_name = #{fileName}
        </if>
        ORDER BY gmt_create DESC 
        limit
		#{start},#{pageSize}
        ;
    </select>
</mapper>
