<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bc.pmpheep.back.commuser.personalcenter.dao.PersonalDao">


 <resultMap id="BaseResultMap" type="Map" ><!-- com.bc.pmpheep.back.commuser.personalcenter.bean.PersonalNewMessage -->
    <id column="id" property="id" />
     <result column="msg_type" property="msg_type"/>
    <result column="bookname" property="book_name"/>
    <result column="buy_url" property="buy_url"/>
    <result column="image_url" property="image_url"/>
    <result column="category_id" property="category_id"/>
    <result column="realname" property="realname"/>
    <result column="avatar" property="avatar"/>
        <result column="group_image" property="group_image"/>
    <result column="group_name" property="group_name"/>
    <result column="grouppeo" property="grouppeo"/>
    <result column="gmt_create" property="gmt_create"/>
    <result column="online_progress" property="online_progress"/>
    <result column="material_name" property="material_name"/>
    <result column="gmt_update" property="gmt_update"/>
    <result column="title" property="title"/>
    <result column="summary" property="summary"/>
    <result column="auth_status" property="auth_status"/>
     <result column="score" property="score"/>
      <result column="content" property="content"/>
           <result column="age_deadline" property="age_deadline"/>
      <result column="exmember" property="exmember"/>
            <result column="iamin" property="iamin"/>
      <result column="is_staging" property="is_staging"/>
            <result column="material_id" property="material_id"/>
         <result column="datebase" property="datebase"/>   
  </resultMap>

<!-- 查询最新收藏信息 -->
  <select id="ListMyConlection"  resultMap="BaseResultMap">
     select  * from book_user_mark a left join book b on a.book_id=b.id  where  a.writer_id=#{id} 
  </select>
<!-- 查好友信息 -->
 <select id="ListMyFriend"  resultMap="BaseResultMap">
     select  b.realname,b.id,b.avatar from writer_friend a left join writer_user b on a.target_id=b.id WHERE  a.request_id=#{id}  AND a.status=2 
  </select>
<!-- 查小组信息 -->
 <select id="ListMyGroup"  resultMap="BaseResultMap">
SELECT c.group_id,c.group_name,c.group_image,d.grouppeo from (select  a.group_id,b.group_name,b.group_image from pmph_group_member a left join pmph_group b on a.group_id=b.id WHERE  a.user_id=#{id} ) c left JOIN 
(select  a.group_id,b.group_name,b.group_image,COUNT(b.group_name ) AS grouppeo from pmph_group_member a left join pmph_group b on a.group_id=b.id group BY a.group_id) d
on c.group_id=d.group_id
  </select>
<!-- 查申报最新动态信息 -->
 <select id="ListMyOfeerTwo"  resultMap="BaseResultMap">
     SELECT
	a.material_id,
	a.user_id,
	a.realname,
	DATE_FORMAT(a.gmt_create,'%Y-%m-%d %h:%i') as  gmt_create,
	a.online_progress,
	b.material_name,
	DATE_FORMAT(a.gmt_update,'%Y-%m-%d %h:%i') as gmt_update,
	 '1' msg_type
FROM
	declaration a
LEFT JOIN material b ON a.material_id = b.id
WHERE
	a.user_id = #{id} 
	AND a.is_deleted = '0'
AND a.online_progress IN (2, 3)
  </select>
  <!-- 查最新文章动态 -->
 <select id="ListMyWritingsTwo"  resultMap="BaseResultMap">
 SELECT id,title,summary,auth_status,DATE_FORMAT(gmt_update,'%Y-%m-%d %h:%i') as gmt_update, '2' msg_type from cms_content where author_id=#{id}  and is_deleted ='0'
  </select>

 <!-- 查最新书评动态 -->
 <select id="ListMyBookNewsTwo"  resultMap="BaseResultMap">
 select a.id,a.score,a.content,DATE_FORMAT(a.gmt_update,'%Y-%m-%d %h:%i') as gmt_update,b.bookname,b.image_url, '3' msg_type from book_user_comment a left JOIN  book b ON a.book_id=b.id where a.writer_id=#{id}  and a.is_deleted='0' and a.is_auth='1'
  </select>


 <!-- 查全部可申请的教材 -->
 <select id="ListAllBookJoin"  resultMap="BaseResultMap" parameterType="PageParameter">
	SELECT
		max(c.online_progress) as online_progress,
		c.is_staging,
		a.deadline as age_deadline,
		a.material_name,
		COUNT(b.id) AS exmember,
		b.material_id,
		(TO_DAYS(NOW()) - TO_DAYS(a.deadline)) AS datebase,
		count(c.id) as iamin,
		c.id as declaration_id
	FROM
		material a
	LEFT JOIN declaration b ON a.id = b.material_id
	LEFT JOIN declaration c ON a.id = c.material_id and c.user_id = #{parameter.logUserId} and c.online_progress != 2
	WHERE
		a.is_deleted = '0'
	AND a.is_public = '0'
	AND a.is_published = '1'
	AND b.online_progress not in  (2)
		<if test="parameter.s!=null and parameter.s!= ''">AND c.id is not null </if> 
	 	<if test="parameter.is_staging!=null and parameter.is_staging!= ''">AND c.is_staging =#{parameter.is_staging}</if>
	 	<if test="parameter.online_progress!=null and parameter.online_progress!= ''">AND c.online_progress=#{parameter.online_progress}</if>
		<if test="parameter.bookname!=null and parameter.bookname!= ''">AND a.material_name like CONCAT('%',#{parameter.bookname},'%')</if>  
	 	<if test="parameter.dateinfo!=null and parameter.dateinfo ==1 ">AND (TO_DAYS(NOW()) - TO_DAYS(a.deadline)) &lt; 0</if>  
	 	<if test="parameter.dateinfo!=null and parameter.dateinfo ==2 ">AND (TO_DAYS(NOW()) - TO_DAYS(a.deadline)) &gt; 0 </if>  
	GROUP BY
		(a.id)
	limit ${start},${pageSize}	
	 </select>
	 
	 <select id="queryMyBooksJoinCount" resultType="Integer" parameterType="PageParameter">
	 	select count(*) from
	 	(
		 	SELECT
				max(c.online_progress) as online_progress,
				c.is_staging,
				a.deadline as age_deadline,
				a.material_name,
				COUNT(b.id) AS exmember,
				b.material_id,
				(TO_DAYS(NOW()) - TO_DAYS(a.deadline)) AS datebase,
				count(c.id) as iamin,
				c.id as declaration_id
			FROM
				material a
			LEFT JOIN declaration b ON a.id = b.material_id
			LEFT JOIN declaration c ON a.id = c.material_id and c.user_id = #{parameter.logUserId} and c.online_progress != 2
			WHERE
				a.is_deleted = '0'
			AND a.is_public = '0'
			AND a.is_published = '1'
			AND b.online_progress not in  (2)
				<if test="parameter.s!=null and parameter.s!= ''">AND c.id is not null </if> 
			 	<if test="parameter.is_staging!=null and parameter.is_staging!= ''">AND c.is_staging =#{parameter.is_staging}</if>
			 	<if test="parameter.online_progress!=null and parameter.online_progress!= ''">AND c.online_progress=#{parameter.online_progress}</if>
			<if test="parameter.bookname!=null and parameter.bookname!= ''">AND a.material_name like CONCAT('%',#{parameter.bookname},'%')</if>  
			 					<if test="parameter.dateinfo!=null and parameter.dateinfo ==1 ">AND (TO_DAYS(NOW()) - TO_DAYS(a.deadline)) &lt; 0</if>  
			 					<if test="parameter.dateinfo!=null and parameter.dateinfo ==2 ">AND (TO_DAYS(NOW()) - TO_DAYS(a.deadline)) &gt; 0 </if>  
			GROUP BY
				(a.id)
		)t
	 </select>
	 
	 
	 

	<!-- 查询选题申报（个人中心 我要出书） -->
	<select id="queryMyTopicChoose" parameterType="PageParameter" resultType="Map">
		SELECT
		t.id,
		t.bookname,
		t.deadline,
		t.source,
		t.type,
		t.gmt_create,
		t.auth_progress
		FROM
		topic t
		<where>
			<if test="parameter.logUserId != null and parameter.logUserId != '' ">
				AND t.user_id =  #{parameter.logUserId}
			</if>
			<if test="parameter.queryName != null and parameter.queryName!= '' ">
				AND t.bookname LIKE  concat('%',#{parameter.queryName},'%')
			</if>
			<if test="parameter.auth_progress != null and parameter.auth_progress != '' ">
				AND t.auth_progress =  #{parameter.auth_progress}
			</if>
		</where>
		limit ${start},${pageSize}
		
	</select>
	
	<select id="queryMyTopicChooseCount" parameterType="PageParameter" resultType="Integer">
		SELECT
		count(*)
		FROM
		topic t
		<where>
			<if test="parameter.logUserId != null and parameter.logUserId != '' ">
				AND t.user_id =  #{parameter.logUserId}
			</if>
			<if test="parameter.queryName != null and parameter.queryName!= '' ">
				AND t.bookname LIKE  concat('%',#{parameter.queryName},'%')
			</if>
			<if test="parameter.auth_progress != null and parameter.auth_progress != '' ">
				AND t.auth_progress =  #{parameter.auth_progress}
			</if>
		</where>
		
	</select>

</mapper>