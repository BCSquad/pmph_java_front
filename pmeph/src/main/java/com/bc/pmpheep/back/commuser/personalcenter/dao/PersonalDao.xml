<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bc.pmpheep.back.commuser.personalcenter.dao.PersonalDao">

 <resultMap id="BaseResultMap" type="com.bc.pmpheep.back.commuser.personalcenter.bean.PersonalNewMessage" >
    <id column="id" property="id" />
     <result column="msg_type" property="msgType"/>
    <result column="bookname" property="book_name"/>
    <result column="buy_url" property="buy_url"/>
    <result column="image_url" property="image_url"/>
    <result column="category_id" property="category_id"/>
    <result column="realname" property="realname"/>
    <result column="avatar" property="avatar"/>
        <result column="group_image" property="group_image"/>
    <result column="group_name" property="group_name"/>
    <result column="grouppeo" property="grouppeo"/>
    <result column="gmt_create" property="gmt_create"/>
    <result column="online_progress" property="online_progress"/>
    <result column="material_name" property="material_name"/>
    <result column="gmt_update" property="gmt_update"/>
    <result column="title" property="title"/>
    <result column="summary" property="summary"/>
    <result column="auth_status" property="auth_status"/>
     <result column="score" property="score"/>
      <result column="content" property="content"/>
           <result column="age_deadline" property="age_deadline"/>
      <result column="exmember" property="exmember"/>
            <result column="iamin" property="iamin"/>
      <result column="is_staging" property="is_staging"/>
            <result column="material_id" property="material_id"/>
         <result column="datebase" property="datebase"/>   
  </resultMap>

<!-- 查询最新收藏信息 -->
  <select id="ListMyConlection"  resultMap="BaseResultMap">
     select  * from book_user_mark a left join book b on a.book_id=b.id  where  a.writer_id=#{id} 
  </select>
<!-- 查好友信息 -->
 <select id="ListMyFriend"  resultMap="BaseResultMap">
     select  b.realname,b.id,b.avatar from writer_friend a left join writer_user b on a.target_id=b.id WHERE  a.request_id=#{id}  AND a.status=2 
  </select>
<!-- 查小组信息 -->
 <select id="ListMyGroup"  resultMap="BaseResultMap">
SELECT c.group_id,c.group_name,c.group_image,d.grouppeo from (select  a.group_id,b.group_name,b.group_image from pmph_group_member a left join pmph_group b on a.group_id=b.id WHERE  a.user_id=#{id} ) c left JOIN 
(select  a.group_id,b.group_name,b.group_image,COUNT(b.group_name ) AS grouppeo from pmph_group_member a left join pmph_group b on a.group_id=b.id group BY a.group_id) d
on c.group_id=d.group_id
  </select>
<!-- 查申报最新动态信息 -->
 <select id="ListMyOfeerTwo"  resultMap="BaseResultMap">
     SELECT
	a.material_id,
	a.user_id,
	a.realname,
	DATE_FORMAT(a.gmt_create,'%Y-%m-%d %h:%i') as  gmt_create,
	a.online_progress,
	b.material_name,
	DATE_FORMAT(a.gmt_update,'%Y-%m-%d %h:%i') as gmt_update,
	 '1' msg_type
FROM
	declaration a
LEFT JOIN material b ON a.material_id = b.id
WHERE
	a.user_id = #{id} 
	AND a.is_deleted = '0'
AND a.online_progress IN (2, 3)
  </select>
  <!-- 查最新文章动态 -->
 <select id="ListMyWritingsTwo"  resultMap="BaseResultMap">
 SELECT id,title,summary,auth_status,DATE_FORMAT(gmt_update,'%Y-%m-%d %h:%i') as gmt_update, '2' msg_type from cms_content where author_id=#{id}  and is_deleted ='0'
  </select>

 <!-- 查最新书评动态 -->
 <select id="ListMyBookNewsTwo"  resultMap="BaseResultMap">
 select a.id,a.score,a.content,DATE_FORMAT(a.gmt_update,'%Y-%m-%d %h:%i') as gmt_update,b.bookname,b.image_url, '3' msg_type from book_user_comment a left JOIN  book b ON a.book_id=b.id where a.writer_id=#{id}  and a.is_deleted='0' and a.is_auth='1'
  </select>


 <!-- 查全部可申请的教材 -->
 <select id="ListAllBookJoin"  resultMap="BaseResultMap">
SELECT
	b.online_progress,
	b.is_staging,
	a.deadline as age_deadline,
	a.material_name,
	COUNT(a.material_name) AS exmember,
	c.material_id,
	(TO_DAYS(NOW()) - TO_DAYS(a.deadline)) AS datebase,
	c.s as iamin
FROM
	material a
LEFT JOIN declaration b ON a.id = b.material_id
RIGHT JOIN (
	SELECT
		sum(t.user_id = #{id}) s,
		t.material_id
	FROM
		declaration t
  where t.is_deleted='0'
	GROUP BY
		t.material_id 

) c  ON c.material_id=a.id

WHERE
	a.is_deleted = '0'
AND a.is_public = '0'
AND a.is_published = '1'
AND b.online_progress not in  (2)
	<if test="s!=null and s!= ''">AND c.s = #{s}</if> 
 	<if test="is_staging!=null and is_staging!= ''">AND b.is_staging =#{is_staging}</if>
 	<if test="online_progress!=null and online_progress!= ''">AND b.online_progress=#{online_progress}</if>
<if test="bookname!=null and bookname!= ''">AND a.material_name like CONCAT('%',#{bookname},'%')</if>  
 					<if test="dateinfo!=null and dateinfo ==1 ">AND (TO_DAYS(NOW()) - TO_DAYS(a.deadline)) &lt; 0</if>  
 					<if test="dateinfo!=null and dateinfo ==2 ">AND (TO_DAYS(NOW()) - TO_DAYS(a.deadline)) &gt; 0 </if>  
GROUP BY
	(a.id)
	 </select>



</mapper>