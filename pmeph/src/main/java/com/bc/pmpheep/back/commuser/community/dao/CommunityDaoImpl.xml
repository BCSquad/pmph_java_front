<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bc.pmpheep.back.commuser.community.dao.CommunityDao">
<resultMap type="java.util.Map" id="baseMap"></resultMap>
     <!--查询公告列表  --> 
     <select id="queryNoticeList" parameterType="map" resultMap="baseMap">
        <!--  select 
            * 
         from 
            cms_content cc left join cms_category  ccg  on cc.category_id=ccg.id
            left join material m on cc.material_id=m.id
         where 
            cc.category_id=3
            <if test="searchText !=null" >
              and  cc.title like #{searchText}
            </if>
         ORDER BY  cc.gmt_create  desc
         limit #{startnum},#{size} -->
         
          select n.* from 
		(select 
		        t.*
		        from cms_content t
		        left join  material b on t.material_id =b.id 
		        where  t.category_id=3 
		        and t.material_id is not null 
		        <![CDATA[and t.material_id >0]]>
                <![CDATA[and b.is_public <> 0]]>
		        and t.auth_status=2
		        and t.is_deleted=0
		 union
		 select 
		        t.*
		        from cms_content t
		        left join  material b on t.material_id =b.id 
		        left join material_org u on b.id=u.material_id
		        left join writer_user p on p.org_id=u.org_id
		        where  t.category_id=3
		        and t.material_id is not null 
		        <![CDATA[and t.material_id >0]]>
		        and b.is_public = 0
		        and t.auth_status=2
		        and t.is_deleted=0 
		        and p.id= #{id}) n
		        <if test="searchText !=null" >
	              where n.title like #{searchText}
	            </if>
			order by n.gmt_create desc limit #{startnum},#{size}
         
     </select>
     
     <!--id查询公告  -->
     <select id="queryNoticeById" parameterType="map" resultMap="baseMap">
        select * from cms_content  where id=#{Id}
     </select>
     
     <!--根据教材id查询社区主页快报列表  -->
     <select id="queryMaterialNoticeList"  parameterType="map" resultMap="baseMap">
        select 
             *  
        from  
            cms_content cc left join cms_category  ccg  on cc.category_id=ccg.id 
       where  
       		cc.material_id=#{materialId} and ccg.category_name='快报管理'
      order by 
            cc.gmt_create desc  
     limit 0,4
     </select>
     
     <!--根据教材id查询本套教材的图书  -->
     <select id="queryTextBookList" parameterType="map" resultMap="baseMap">
        select 
           material_id,b.bookname,b.gmt_create,b.image_url,b.id as bookId
        from 
            book b 
        where 
            b.material_id=#{materialId}
        order by 
            b.sort
        limit 0,10
     </select>
     
     <!--查询社区主页精选书评  -->
     <select id="querySomeComment" parameterType="map" resultMap="baseMap">
        select c.*,bk.bookname,w.realname  
        from book_user_comment c left join book bk on c.book_id=bk.id   
        left join  writer_user w on c.writer_id=w.id
		where c.book_id in(
			select b.id 
			from material m left join book  b  on m.id=b.material_id
			where m.id=#{materialId}
		) and c.is_auth>0  and c.is_deleted=0 and c.is_long>0 and c.is_hide=0
		ORDER BY
		 c.score
		limit 0,4
     </select>
</mapper>