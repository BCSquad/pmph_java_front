<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bc.pmpheep.back.authadmin.backlog.dao.ScheduleDao" >
	
	<!-- 查询待办事项列表 -->
	<select id="selectScheduleList" parameterType="PageParameter" resultType="java.util.Map">
		SELECT * FROM(
		SELECT d.id as ID,d.realname AS NAME,d.gmt_create AS TIME,m.`material_name` AS CONTENT,d.material_id as auditId,"A" as TYPE,w.avatar,d.online_progress as  online_progress
		FROM declaration d 
		LEFT JOIN material m
		ON d.`material_id` = m.`id`
		LEFT JOIN org_user u
		ON d.`org_id` = u.`org_id`
		left join writer_user w
		on d.user_id = w.id
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			u.`id` = #{parameter.userId} AND (d.online_progress='1' or d.online_progress='4')
			and m.is_all_textbook_published = 0 and m.is_force_end = 0
			and DATE_FORMAT(m.actual_deadline,'%Y%m%d') &gt; '20180412'<!-- 过滤老系统中的数据 -->
			<if test="null!=parameter.week">AND d.gmt_create >= #{parameter.week} </if>
			<if test="null!=parameter.month">AND d.gmt_create >= #{parameter.month}</if>
			<if test="null!=parameter.year">AND d.gmt_create >= #{parameter.year}</if>
		</trim>
		ORDER BY d.gmt_create DESC) t1
		UNION 
		SELECT * FROM (
		SELECT w1.org_id,w1.realname,w.gmt_create,"教师资格认证",w1.id,"B",w1.avatar, '8' as  online_progress
		FROM writer_user_certification w
		LEFT JOIN org_user u1
		ON w.org_id = u1.org_id
		LEFT JOIN writer_user w1		
		ON w1.id= w.user_id 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			u1.`id` = #{parameter.userId} AND w.progress='1' 
			<if test="null!=parameter.week">AND w.gmt_create >= #{parameter.week} </if>
			<if test="null!=parameter.month">AND w.gmt_create >= #{parameter.month}</if>
			<if test="null!=parameter.year">AND w.gmt_create >= #{parameter.year}</if>
		</trim>
		ORDER BY w.gmt_create DESC) t2
		ORDER BY TIME DESC
		limit #{start},#{pageSize}
	</select>
	<!-- 查询待办事项条数 -->
	<select id="selectScheduleCount" parameterType="java.util.Map" resultType="int" >
		SELECT COUNT(*) FROM (
		SELECT * FROM(
		SELECT d.realname AS NAME,d.gmt_create AS TIME,m.`material_name` AS Content,"A" as TYPE
		FROM declaration d 
		LEFT JOIN material m
		ON d.`material_id` = m.`id`
		LEFT JOIN org_user u
		ON d.`org_id` = u.`org_id`
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			u.`id` = #{parameter.userId} AND (d.online_progress='1' or d.online_progress='4')
			and m.is_all_textbook_published = 0 and m.is_force_end = 0
			and DATE_FORMAT(m.actual_deadline,'%Y%m%d') &gt; '20180412'<!-- 过滤老系统中的数据 -->
			<if test="null!=parameter.week">AND d.gmt_create >= #{parameter.week} </if>
			<if test="null!=parameter.month">AND d.gmt_create >= #{parameter.month}</if>
			<if test="null!=parameter.year">AND d.gmt_create >= #{parameter.year}</if>
		</trim>
		ORDER BY d.gmt_create DESC) t1
		UNION 
		SELECT * FROM (
		SELECT w1.realname,w.gmt_create,"教师资格认证","B" FROM writer_user_certification w
		LEFT JOIN org_user u1
		ON w.org_id = u1.org_id
		LEFT JOIN writer_user w1		
		ON w1.id= w.user_id 
		<trim prefix="WHERE" prefixOverrides="AND|OR">
			u1.`id` = #{parameter.userId} AND w.progress='1' 
			<if test="null!=parameter.week">AND w.gmt_create >= #{parameter.week} </if>
			<if test="null!=parameter.month">AND w.gmt_create >= #{parameter.month}</if>
			<if test="null!=parameter.year">AND w.gmt_create >= #{parameter.year}</if>
		</trim>
		ORDER BY w.gmt_create DESC) t2)t3
	</select>
	<!-- 查询已办事项列表 -->
	<select id="selectDoneSchedule" parameterType="PageParameter" resultType="java.util.Map">
		SELECT * FROM(
		SELECT d.realname AS NAME,d.gmt_create AS gmt_create,m.`material_name` AS CONTENT,
		d.material_id AS AUDITID,"A" AS TYPE,d.gmt_update AS UPDATETIME,d.`online_progress` AS PROGRESS,w.avatar
		FROM declaration d 
		LEFT JOIN material m
		ON d.`material_id` = m.`id`
		LEFT JOIN org_user u
		ON d.`org_id` = u.`org_id`
		left join writer_user w
		on d.user_id = w.id
		WHERE	u.`id` = #{parameter.userId} AND d.online_progress IN(2,3)
		) t1
		UNION
		SELECT * FROM (
		SELECT w1.realname,w.gmt_create AS gmt_create,"教师资格认证",w1.id,"B",w1.gmt_update,w.progress,w1.avatar
		FROM writer_user_certification w
		LEFT JOIN org_user u1
		ON w.org_id = u1.org_id
		LEFT JOIN writer_user w1
		ON w1.id= w.user_id
		WHERE u1.`id` = #{parameter.userId} AND w.progress IN(2,3)
		) t2
		ORDER BY gmt_create DESC
		limit #{start},#{pageSize}
	</select>
	<!-- 查询已办事项条数 -->
	<select id="selectDoneScheduleCount" parameterType="java.util.Map" resultType="int" >
		SELECT COUNT(*) FROM (
		SELECT * FROM(
		SELECT d.realname AS NAME,d.gmt_create AS gmt_create,m.`material_name` AS TYPE
		FROM declaration d 
		LEFT JOIN material m
		ON d.`material_id` = m.`id`
		LEFT JOIN org_user u
		ON d.`org_id` = u.`org_id`
		WHERE	u.`id` = #{parameter.userId} AND d.online_progress IN (2,3)	
		ORDER BY d.gmt_create DESC) t1
		UNION 
		SELECT * FROM (
		SELECT w1.username,w.gmt_create AS gmt_create,"教师资格认证" FROM writer_user_certification w
		LEFT JOIN org_user u1
		ON w.org_id = u1.org_id
		LEFT JOIN writer_user w1		
		ON w1.id= w.user_id 
		WHERE	u1.`id` = #{parameter.userId} AND w.progress IN (2,3) 
		ORDER BY w.gmt_create DESC) t2)t3
	</select>
	
	<!-- 查询机构用户信息 -->
	<select id="selectOrgUser" parameterType="Long" resultType="java.util.Map">
		SELECT * FROM org_user u
		LEFT JOIN org o
		ON u.`org_id`=o.`id`
		WHERE u.`id`=#{userId}
	</select>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- 查询已办事项id集合 -->
	<select id="selectUserMessageList" parameterType="java.util.Map" resultType="String">
		select msg_id,gmt_create,title 
		from user_message 
		where receiver_id = #{userId} 
		ORDER BY gmt_create DESC
		limit #{startPage},#{endPage}
	</select>
	<!-- 查询已办事项集合 -->
	<select id="selectUserMessageNameAndTime" parameterType="java.util.Map" resultType="java.util.Map">
		select gmt_create,title,msg_id 
		from user_message 
		where receiver_id = #{userId} 
		<if test="null!=time">AND gmt_create like #{time} </if>
		ORDER BY gmt_create DESC
		limit #{startPage},#{endPage}
	</select>
	
	<!-- 查询已办事项id集合数量 -->
	<select id="selectUserMessageCount" parameterType="java.util.Map" resultType="int">
		select count(*) from user_message where receiver_id = #{userId}	<if test="null!=time">AND gmt_create like #{time} </if>
	</select>
	
	
</mapper>